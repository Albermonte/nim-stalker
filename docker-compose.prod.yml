services:
  genesis-init:
    image: alpine:latest
    volumes:
      - genesis:/genesis
    command:
      - sh
      - -c
      - |
        set -e
        if [ -s /genesis/nimiq-genesis-main-albatross.toml ]; then
          echo 'Genesis file already exists'; exit 0
        fi
        rm -f /genesis/nimiq-genesis-main-albatross.toml
        echo 'Downloading genesis file...'
        wget -O /genesis/nimiq-genesis-main-albatross.toml \
          https://ipfs.nimiq.io/ipfs/QmWcRRRw4FaKRrznMFt6KemAM35uo9QknMkDaeBzTod33R
        echo 'Done'

  node:
    image: ghcr.io/albermonte/core-rs-albatross-slim:latest
    environment:
      NIMIQ_OVERRIDE_MAINNET_CONFIG: /genesis/nimiq-genesis-main-albatross.toml
    volumes:
      - nimiqdata:/root/.nimiq
      - genesis:/genesis:ro
    depends_on:
      genesis-init:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -X POST -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"method\":\"isConsensusEstablished\",\"params\":[],\"id\":1}' http://localhost:8648"]
      interval: 15s
      timeout: 10s
      retries: 40
      start_period: 300s

  db:
    image: neo4j:5-community
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      NEO4J_PLUGINS: '[]'
      NEO4J_server_memory_heap_initial__size: 512m
      NEO4J_server_memory_heap_max__size: 1G
      NEO4J_server_memory_pagecache_size: 2G
    volumes:
      - neo4jdata:/data
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD} 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      target: production
    environment:
      NEO4J_URI: bolt://db:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      NIMIQ_RPC_URL: ${NIMIQ_RPC_URL:-http://node:8648}
      CORS_ORIGIN: ${CORS_ORIGIN:-https://nimstalker.com}
      API_KEY: ${API_KEY:?API_KEY is required in production}
      PORT: 3001
      SENSITIVE_RATE_LIMIT_WINDOW_MS: ${SENSITIVE_RATE_LIMIT_WINDOW_MS:-60000}
      SENSITIVE_RATE_LIMIT_PER_WINDOW: ${SENSITIVE_RATE_LIMIT_PER_WINDOW:-300}
      SENSITIVE_RATE_LIMIT_MAIN_ORIGIN_PER_WINDOW: ${SENSITIVE_RATE_LIMIT_MAIN_ORIGIN_PER_WINDOW:-100000}
      MAIN_ORIGIN_HOSTS: ${MAIN_ORIGIN_HOSTS:-localhost,nimstalker.com,www.nimstalker.com}
    depends_on:
      db:
        condition: service_healthy
      node:
        condition: service_started
    restart: unless-stopped

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      target: production
    ports:
      - "80:3000"
    environment:
      NEXT_PUBLIC_API_URL: ${API_URL:-http://api:3001}
    depends_on:
      - api
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - web
      - api
    restart: unless-stopped
    profiles:
      - with-nginx

volumes:
  neo4jdata:
  nimiqdata:
  genesis:
