services:
  node:
    image: ghcr.io/albermonte/core-rs-albatross-slim:latest
    environment:
      NIMIQ_OVERRIDE_MAINNET_CONFIG: /genesis/nimiq-genesis-main-albatross.toml
    volumes:
      - nimiqdata:/root/.nimiq
      - ./nimiq-genesis-main-albatross.toml:/genesis/nimiq-genesis-main-albatross.toml:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -X POST -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"method\":\"isConsensusEstablished\",\"params\":[],\"id\":1}' http://localhost:8648 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

  db:
    image: neo4j:5-community
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      NEO4J_PLUGINS: '[]'
      NEO4J_server_memory_heap_initial__size: 512m
      NEO4J_server_memory_heap_max__size: 1G
      NEO4J_server_memory_pagecache_size: 2G
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4jdata:/data
    deploy:
      resources:
        limits:
          memory: 4G
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD} 'RETURN 1' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      target: development
    ports:
      - "3001:3001"
    environment:
      NEO4J_URI: bolt://db:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      NIMIQ_RPC_URL: ${NIMIQ_RPC_URL:-http://node:8648}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      PORT: 3001
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      db:
        condition: service_healthy
      node:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "bun -e 'fetch(\"http://localhost:3001/health\").then(r=>{if(!r.ok)process.exit(1)}).catch(()=>process.exit(1))'"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    volumes:
      - ./apps/api/src:/app/apps/api/src
      - ./packages/shared:/app/packages/shared
    develop:
      watch:
        - path: ./apps/api/package.json
          action: sync+restart
          target: /app/apps/api/package.json

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      target: development
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:3001
    deploy:
      resources:
        limits:
          memory: 1G
    depends_on:
      api:
        condition: service_healthy
    develop:
      watch:
        - path: ./apps/web/package.json
          action: sync+restart
          target: /app/apps/web/package.json
        - path: ./apps/web/app
          action: sync
          target: /app/apps/web/app
          ignore:
            - "**/*.test.tsx"
            - "**/__tests__/**"
        - path: ./apps/web/components
          action: sync
          target: /app/apps/web/components
        - path: ./apps/web/lib
          action: sync
          target: /app/apps/web/lib
        - path: ./apps/web/store
          action: sync
          target: /app/apps/web/store
        - path: ./packages/shared
          action: sync
          target: /app/packages/shared
          ignore:
            - "node_modules/**"
            - ".turbo/**"
            - "dist/**"
            - "*.tsbuildinfo"

volumes:
  neo4jdata:
  nimiqdata:
