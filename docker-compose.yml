services:
  genesis-init:
    image: alpine:latest
    volumes:
      - genesis:/genesis
    command:
      - sh
      - -c
      - |
        set -e
        if [ -s /genesis/nimiq-genesis-main-albatross.toml ]; then
          echo 'Genesis file already exists'; exit 0
        fi
        rm -f /genesis/nimiq-genesis-main-albatross.toml
        echo 'Downloading genesis file...'
        wget -O /genesis/nimiq-genesis-main-albatross.toml \
          https://ipfs.nimiq.io/ipfs/QmWcRRRw4FaKRrznMFt6KemAM35uo9QknMkDaeBzTod33R
        echo 'Done'

  node-data-init:
    image: alpine:latest
    user: "0:0"
    volumes:
      - ${NIMIQ_DATA_DIR:-./.data/nimiq}:/nimiq-data
    command:
      - sh
      - -c
      - |
        set -e
        mkdir -p /nimiq-data
        chown -R ${NIMIQ_NODE_UID:-1001}:${NIMIQ_NODE_GID:-1001} /nimiq-data
        chmod -R u+rwX,g+rwX /nimiq-data

  node:
    image: ghcr.io/albermonte/core-rs-albatross-slim:latest
    user: "${NIMIQ_NODE_UID:-1001}:${NIMIQ_NODE_GID:-1001}"
    environment:
      NIMIQ_OVERRIDE_MAINNET_CONFIG: /genesis/nimiq-genesis-main-albatross.toml
    volumes:
      # Keep chain data on the host so it survives container/volume recreation.
      - ${NIMIQ_DATA_DIR:-./.data/nimiq}:/home/nimiq/.nimiq
      - ./docker/nimiq-client.toml:/home/nimiq/.nimiq/client.toml:ro
      - genesis:/genesis:ro
    depends_on:
      genesis-init:
        condition: service_completed_successfully
      node-data-init:
        condition: service_completed_successfully
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -X POST -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"2.0\",\"method\":\"isConsensusEstablished\",\"params\":[],\"id\":1}' http://localhost:8648"]
      interval: 15s
      timeout: 10s
      retries: 40
      start_period: 300s

  db:
    image: neo4j:5-community
    environment:
      NEO4J_AUTH: ${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      NEO4J_PLUGINS: '[]'
      NEO4J_server_memory_heap_initial__size: ${NEO4J_HEAP_INITIAL:-512m}
      NEO4J_server_memory_heap_max__size: ${NEO4J_HEAP_MAX:-1G}
      NEO4J_server_memory_pagecache_size: ${NEO4J_PAGECACHE:-512m}
      NEO4J_dbms_memory_transaction_total_max: ${NEO4J_TX_MEMORY_MAX:-512m}
      NEO4J_db_memory_transaction_total_max: ${NEO4J_TX_MEMORY_MAX:-512m}
    volumes:
      # External named volume: fast DB I/O and persistence unless explicitly removed.
      - neo4jdata:/data
    deploy:
      resources:
        limits:
          memory: ${NEO4J_MEMORY_LIMIT:-3G}
    healthcheck:
      test: ["CMD-SHELL", "/var/lib/neo4j/bin/cypher-shell -u ${NEO4J_USER:-neo4j} -p ${NEO4J_PASSWORD} 'RETURN 1' || exit 1"]
      interval: 15s
      timeout: 15s
      retries: 30
      start_period: 600s

  api:
    image: nimiq-graph-api:dev
    pull_policy: build
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      target: development
    ports:
      - "3001:3001"
    environment:
      NEO4J_URI: bolt://db:7687
      NEO4J_USER: ${NEO4J_USER:-neo4j}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      NIMIQ_RPC_URL: ${NIMIQ_RPC_URL:-http://node:8648}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      BACKFILL_CHECKPOINT_INTERVAL: ${BACKFILL_CHECKPOINT_INTERVAL:-100}
      BACKFILL_THROTTLE_MS: ${BACKFILL_THROTTLE_MS:-0}
      BACKFILL_THROTTLE_EVERY_BATCHES: ${BACKFILL_THROTTLE_EVERY_BATCHES:-10}
      BACKFILL_DEFER_AGGREGATES: ${BACKFILL_DEFER_AGGREGATES:-true}
      BACKFILL_RPC_PREFETCH: ${BACKFILL_RPC_PREFETCH:-4}
      GAP_REPAIR_INTERVAL_MS: ${GAP_REPAIR_INTERVAL_MS:-300000}
      GAP_REPAIR_MAX_PER_CYCLE: ${GAP_REPAIR_MAX_PER_CYCLE:-50}
      LIVE_TRANSITION_GAP_BUDGET_MS: ${LIVE_TRANSITION_GAP_BUDGET_MS:-5000}
      LIVE_DEFER_AGGREGATES: ${LIVE_DEFER_AGGREGATES:-true}
      VERIFY_BATCH_DEFER_AGGREGATES: ${VERIFY_BATCH_DEFER_AGGREGATES:-true}
      VERIFY_BATCH_AGGREGATE_PAIR_BATCH_SIZE: ${VERIFY_BATCH_AGGREGATE_PAIR_BATCH_SIZE:-5}
      VERIFY_BATCH_AGGREGATE_FLUSH_LIMIT: ${VERIFY_BATCH_AGGREGATE_FLUSH_LIMIT:-50}
      VERIFY_BATCH_AGGREGATE_FLUSH_TICK_MS: ${VERIFY_BATCH_AGGREGATE_FLUSH_TICK_MS:-1000}
      EDGE_AGGREGATE_PAIR_CHUNK_SIZE: ${EDGE_AGGREGATE_PAIR_CHUNK_SIZE:-5}
      UPDATE_ADDRESS_TXCOUNT_ON_PAIR_UPDATE: ${UPDATE_ADDRESS_TXCOUNT_ON_PAIR_UPDATE:-false}
      REBUILD_PHASE1_CHUNK_SIZE: ${REBUILD_PHASE1_CHUNK_SIZE:-1000}
      REBUILD_PHASE1_ROWS_PER_TX: ${REBUILD_PHASE1_ROWS_PER_TX:-250}
      REBUILD_PHASE2_CHUNK_SIZE: ${REBUILD_PHASE2_CHUNK_SIZE:-1000}
      REBUILD_PHASE2_ROWS_PER_TX: ${REBUILD_PHASE2_ROWS_PER_TX:-250}
      REBUILD_CHUNK_RETRY_ATTEMPTS: ${REBUILD_CHUNK_RETRY_ATTEMPTS:-3}
      REBUILD_CHUNK_RETRY_BASE_DELAY_MS: ${REBUILD_CHUNK_RETRY_BASE_DELAY_MS:-2000}
      REBUILD_CHUNK_RETRY_MAX_DELAY_MS: ${REBUILD_CHUNK_RETRY_MAX_DELAY_MS:-30000}
      REBUILD_STRATEGY: ${REBUILD_STRATEGY:-keyset}
      PORT: 3001
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      db:
        condition: service_healthy
      node:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "bun -e 'fetch(\"http://localhost:3001/health\").then(r=>{if(!r.ok)process.exit(1)}).catch(()=>process.exit(1))'"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    volumes:
      - ./apps/api/src:/app/apps/api/src
      - ./packages/shared:/app/packages/shared
      - indexerdata:/app/apps/api/data
    develop:
      watch:
        - path: ./apps/api/package.json
          action: sync+restart
          target: /app/apps/api/package.json

  web:
    image: nimiq-graph-web:dev
    pull_policy: build
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      target: development
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:3001
    deploy:
      resources:
        limits:
          memory: 1G
    depends_on:
      api:
        condition: service_healthy
    develop:
      watch:
        - path: ./apps/web/package.json
          action: sync+restart
          target: /app/apps/web/package.json
        - path: ./apps/web/app
          action: sync
          target: /app/apps/web/app
          ignore:
            - "**/*.test.tsx"
            - "**/__tests__/**"
        - path: ./apps/web/components
          action: sync
          target: /app/apps/web/components
        - path: ./apps/web/lib
          action: sync
          target: /app/apps/web/lib
        - path: ./apps/web/store
          action: sync
          target: /app/apps/web/store
        - path: ./packages/shared
          action: sync
          target: /app/packages/shared
          ignore:
            - "node_modules/**"
            - ".turbo/**"
            - "dist/**"
            - "*.tsbuildinfo"

volumes:
  neo4jdata:
    external: true
    name: ${NEO4J_VOLUME_NAME:-neo4jdata}
  genesis:
  indexerdata:
